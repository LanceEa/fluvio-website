{{- $current := .Page -}}
{{- $all_pages := (where .Site.Pages "Section" .Section).ByWeight -}}

{{/* Params: .current .page .class */}}
{{ define "menu-item" }}
    {{- $selected := "" -}}
    {{- if eq .current .page -}}
        {{- if .class -}}
            {{- $selected = " selected-first" -}}
        {{- else -}}
            {{- $selected = " selected" -}}
        {{- end -}}
    {{- end -}}
    {{- $menu := .page.Params.menu | default .page.LinkTitle -}}
    {{- if .page.Params.link.local }}
        <div class="card item{{ $selected }}"><a href="{{ .page.Params.link.local }}"
            {{- if .class -}}
                class="{{ .class }}"
            {{- end -}}
        >{{ $menu }}</a></div>
    {{- else if .page.Params.link.external }}
        <div class="card item{{ $selected }}"><a href="{{ .page.Params.link.external }}"
            {{- if .class -}}
                class="{{ .class }}"
            {{- end -}} 
        target="_blank">{{ $menu }}</a></div>
    {{- else }}
        <div class="card item{{ $selected }}"><a href="{{ .page.RelPermalink }}"
            {{- if .class -}}
                class="{{ .class }}"
            {{- end -}}
        >{{ $menu | markdownify}}</a></div>
    {{- end -}}
{{ end }}

<div class=".sidebar">
<!-- Overview Page -->
{{- with .Site.GetPage .Section }}
    {{ if not .Params.hidden }}
        {{- block "menu-item" (dict "current" $current "page" . "class" "first") -}}{{- end }}
    {{- end -}}
{{ end -}}

<!-- Top Pages -->
{{ range $all_pages }}
    {{ if not .Params.hidden }}
        {{ if and .IsPage (eq .CurrentSection .FirstSection) }}
            {{- block "menu-item" (dict "current" $current "page" .) -}}{{- end }}
        {{- end -}}
    {{- end -}}
{{- end -}}

<!-- Sections -->
{{- range $all_pages -}}
    {{ if not .Params.hidden }}
        {{- if and .IsSection .Page.Parent.IsSection -}}
            <div class="section">
                <div class="title">{{.Title}}</div>
            {{ range .Pages.ByWeight }}
                {{- block "menu-item" (dict "current" $current "page" .) -}}{{- end }}
            {{- end -}}
            </div>
        {{- end -}}
    {{- end -}}
{{- end -}}
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $(".sidebar").mCustomScrollbar({
            theme: "minimal"
        });

        $('#dismiss, .page-overlay').on('click', function () {
            // hide sidebar
            $('.sidebar-area').removeClass('active');
            $('.sidebar').removeClass('ontop');
            $('.sidebar').css({'font-size': ''});
            $('.sidebar').css({'width': ''});
            
            // renable elements
            $('.doc-area').css({'display': ''});
            $('.toc-area').css({'display': ''});
            $('.footer').css({'display': ''});
            
            // hide overlay
            $('.page-overlay').removeClass('active');
        });

        $('.sidebar-nav').on('click', function () {
            // open sidebar
            $('.sidebar-area').addClass('active');
            $('.sidebar').addClass('ontop');
            $('.sidebar').css({'font-size': '1.1em'});
            $('.sidebar').css({'width': '300px'});

            // fade in the overlay
            $('.page-overlay').addClass('active');
            $('.collapse.in').toggleClass('in');
            $('a[aria-expanded=true]').attr('aria-expanded', 'false');

            // hide elements
            $('.doc-area').css({'display': 'none'});
            $('.toc-area').css({'display': 'none'});
            $('.footer').css({'display': 'none'});
        });
    });
</script>