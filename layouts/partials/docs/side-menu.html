{{- $current := .Page -}}
{{- $all_pages := (where .Site.Pages "Section" .Section).ByWeight -}}

<div class="sMenu">
<!-- Top Pages -->
{{ range $all_pages }}
   {{ if and .IsPage (eq .CurrentSection .FirstSection) }}
            {{- $selected := "" -}}
            {{- if eq $current .Page -}}
        	    {{- $selected = " selected" -}}
            {{- end -}}
    	    {{- $menu := .Page.Params.menu | default .Page.LinkTitle -}}
	        {{- if isset .Page.Params "link" }}
		        <div class="card {{ $selected }}"><a href="{{ .Page.Params.link }}" target="_blank">{{ $menu }}</a></div>
	        {{- else }}
		        <div class="card {{ $selected }}"><a href="{{ .Page.RelPermalink }}">{{ $menu }}</a></div>
	        {{- end -}}
    {{ end }}
{{ end }}

<!-- Sections -->
{{- range $all_pages -}}
    {{- if and .IsSection .Page.Parent.IsSection -}}
        <div class="section">
            <div class="title">{{.Title}}</div>
        {{ range .Pages.ByWeight }}
            {{- $selected := "" -}}
            {{- if eq $current .Page -}}
        	    {{- $selected = " selected" -}}
            {{- end -}}
    	    {{- $menu := .Page.Params.menu | default .Page.LinkTitle -}}
	        {{- if isset .Page.Params "link" }}
		        <div class="card {{ $selected }}"><a href="{{ .Page.Params.link }}" target="_blank">{{ $menu }}</a></div>
	        {{- else }}
		        <div class="card {{ $selected }}"><a href="{{ .Page.RelPermalink }}">{{ $menu }}</a></div>
	        {{- end -}}
        {{- end -}}
        </div>
    {{- end -}}
{{- end -}}
</div>