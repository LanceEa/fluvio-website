{{/* Local context scratch */}}
{{- $scratch := newScratch -}}

{{/* Collect authors */}}
{{- $scratch.Set "authors" ( slice ) -}}
{{- $scratch.Set "noAuthors" 0 -}}

{{- $pages := where site.RegularPages.ByWeight "Type" "tutorials" -}}
{{- range $pages -}}
  {{- with .Params.githubAuthors -}}
    {{- range . -}}
        {{- if ( not ( in ($scratch.Get "authors") . ) ) -}}
            {{- $scratch.Add "authors" . -}}
        {{- end -}}
    {{- end -}}
  {{- else -}}
    {{- $scratch.Add "noAuthors" 1 -}}
  {{- end -}}
{{- end -}}

{{/* Process tags */}}
{{- $scratch.Set "untagged" 0 -}}
{{- $tags := site.Taxonomies.tags.ByCount -}}

{{- range $pages -}}
  {{- with .Params.tags -}}
  {{- else -}}
    {{- $scratch.Add "untagged" 1 -}}
  {{- end -}}
{{- end -}}

<div  class="container tiles">
  
  <div class="header">
    <div class="row"><h1>{{ .page.Title }}</h1></div>
    <div class="row"><div class="subheader">{{ .page.Params.desc }}</div></div>
  </div>

  <div class="tf-wrapper">
    <div class="tf-buttons-container flex-grow">
      
      {{ range $tags }}
        {{ if .Term }}
          <button type="button" class="btn btn-outline-primary tag-button" id="tag-{{ .Term | replaceRE "[.]" "_" | urlize }}" onclick="htf.checkFilter('{{ .Term | replaceRE "[.]" "_" | urlize }}', 'tag-')">
            <i class="fas fa-check"></i>
            <span>{{.Term | humanize | title }}</span>
          </button>
        {{ end }}
      {{ end }}
      
    </div>
  </div>

  <div class="row">
    {{- range $pages -}}
      {{- $hidden := .Params.hidden | default false -}}

      {{/* Process linkTo */}}
      {{- $linkTo :=  .Params.linkToDefault | default "" -}}
      {{- if eq $linkTo "" -}}
          {{- if .Params.tags -}}
          {{$firstTag := index (.Params.tags) 0}}
            {{- if ne $firstTag nil -}}
              {{- $linkTo = (print .File.BaseFileName "-" ($firstTag | lower)) -}}
            {{- end -}}
          {{- end -}}
      {{- end -}}
      {{- if eq $linkTo "" -}}
        {{- $linkTo = .RelPermalink -}}	
      {{- end -}}

      {{ if ne $hidden true }}
        <div class="col-md-6 col-lg-4 box tf-filter-item" 
          data-tags="{{ with .Params.tags }}{{ range . }}{{ . | replaceRE "[.]" "_" | urlize }} {{ end }}{{ else }} tfuntagged{{ end }}"
          data-authors="{{ with .Params.githubAuthors }}{{ range . }}{{ . | replaceRE "[.]" "_" | urlize }} {{end}}{{else}}no-author{{end}}"
        >        
          <div class="card h-100">

            <div class="card-body">
              <div class="title">
                <a href="{{ $linkTo }}">{{ .Title}}</a>
              </div>

              <div class="lang">
                {{- partial "tutorial/print-languages" . -}}
              </div>

              <div class="desc">
                {{ .Params.desc}}
              </div>
            </div>

            <div>
              <div class="authors">
                {{- partial "tutorial/print-authors" . -}}
              </div>
            </div>

            <div class="card-footer">
              <div class="difficulty">
                {{- partial "tutorial/print-difficulty" . -}}
              </div>
              <div class="link">
                <a href="{{ $linkTo }}"><i class="fas fa-arrow-right"></i> Expand</a>
              </div>
            </div>

          </div>
        </div>
      {{- end -}}
    {{- end -}}
  </div>

</div>

<script>
  var htfConfig = {
    filters: [
      {
        name: 'tags',
        prefix: 'tag-',
        buttonClass: 'tag-button',
        attrName: 'data-tags',
        selectedPrefix: 'stags-',
        countPrefix: 'ctags-'
      }
    ],
    showItemClass: "show-item",
    filterItemClass: "tf-filter-item",
    activeButtonClass: "active",
    counterSelector: "selectedItemCount",
    populateCount: false,
    setDisabledButtonClass: "disable-button"
  } 
  var htf = new TagsFilter(htfConfig);
</script>